<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Savory Meal Planner</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* All CSS styles from the original file remain here */
        /* ... (CSS remains unchanged) ... */
    </style>
</head>
<body>
    <!-- Floating decorative elements -->
    <div class="floating-element"></div>
    <div class="floating-element"></div>
    <div class="floating-element"></div>

    <!-- Loading overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <div class="container">
        <!-- Navigation -->
        <nav>
            <div class="logo">
                <i class="fas fa-utensils"></i>
                Savory
            </div>
            <div class="nav-links">
                <a href="#"><i class="fas fa-calendar-alt"></i> Calendar</a>
                <a href="#"><i class="fas fa-box-open"></i> Inventory</a>
                <a href="#"><i class="fas fa-shopping-basket"></i> Grocery</a>
                <a href="#"><i class="fas fa-cog"></i> Settings</a>
                <div class="user-section">
                    <div class="streak-container" id="streakContainer">
                        <i class="fas fa-fire"></i> <span id="streakCount">0</span> Day Streak
                    </div>
                    <a href="#" id="userAuthBtn"><i class="fas fa-user"></i> <span id="authText">Login</span></a>
                </div>
            </div>
            <div class="hamburger-menu" id="hamburgerMenu">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </nav>

        <!-- Login/Signup Form -->
        <div class="forms" id="authForm" style="display: none;">
            <h2 class="main-heading">Welcome to Savory</h2>
            <div class="form-group">
                <label for="authEmail"><i class="fas fa-envelope"></i> Email</label>
                <input type="email" id="authEmail" name="authEmail" placeholder="Enter your email" required>
            </div>
            <div class="form-group">
                <label for="authPassword"><i class="fas fa-lock"></i> Password</label>
                <input type="password" id="authPassword" name="authPassword" placeholder="Enter your password" required>
            </div>
            <div class="form-group" id="authNameGroup" style="display: none;">
                <label for="authName"><i class="fas fa-user"></i> Full Name</label>
                <input type="text" id="authName" name="authName" placeholder="Enter your full name">
            </div>
            <button type="button" id="authSubmitBtn" class="btn-submit">
                <i class="fas fa-sign-in-alt"></i> Login
            </button>
            <div class="form-group" style="text-align: center; margin-top: 15px;">
                <a href="#" id="authToggleLink">Don't have an account? Sign up</a>
            </div>
        </div>

        <!-- Main Content - Visible only when logged in -->
        <div id="mainContent" style="display: none;">
            <h1 class="main-heading">Plan Your Meals</h1>
            
            <!-- Plan Type Toggle -->
            <div class="plan-type-toggle">
                <button class="plan-type-btn active" data-plan-type="weekly">
                    <i class="fas fa-calendar-week"></i> Weekly Plan
                </button>
                <button class="plan-type-btn" data-plan-type="daily">
                    <i class="fas fa-sun"></i> Daily Meal
                </button>
            </div>

            <!-- Meal Planner Form -->
            <form id="mealPlannerForm" class="forms">
                <!-- Inventory Toggle Section -->
                <div class="inventory-toggle">
                    <label for="useInventory">
                        <i class="fas fa-box-open"></i> Generate meals using my inventory
                    </label>
                    <div class="toggle-switch">
                        <input type="checkbox" id="useInventory" name="useInventory">
                        <span class="toggle-slider"></span>
                    </div>
                </div>
                
                <div class="inventory-items" id="inventoryItems">
                    <!-- Inventory items will be populated dynamically -->
                    <div class="inventory-item">
                        <div>
                            <span>Loading inventory...</span>
                        </div>
                    </div>
                </div>
                
                <div class="form-row">
                    <!-- Weekly Budget (only for weekly plan) -->
                    <div class="form-group" id="weeklyBudgetGroup">
                        <label for="mpBudget"><i class="fas fa-wallet"></i> Weekly Budget ($)</label>
                        <input type="number" id="mpBudget" name="mpBudget" min="50" step="10" value="150" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="mpSpecific"><i class="fas fa-apple-alt"></i> Specific Foods To Include</label>
                        <input type="text" id="mpSpecific" name="mpSpecific" placeholder="e.g., chicken, broccoli, quinoa">
                    </div>
                </div>
                
                <!-- Mood Selector - Hidden by default, shown only for daily plan -->
                <div class="form-group" id="moodSelectorContainer" style="display: none;">
                    <label><i class="fas fa-heart"></i> Meal Mood</label>
                    <div class="mood-selector">
                        <button type="button" class="mood-btn active" data-mood="any"><i class="fas fa-question"></i> Any</button>
                        <button type="button" class="mood-btn" data-mood="comfort"><i class="fas fa-cookie"></i> Comfort</button>
                        <button type="button" class="mood-btn" data-mood="quick"><i class="fas fa-bolt"></i> Quick</button>
                        <button type="button" class="mood-btn" data-mood="energizing"><i class="fas fa-battery-full"></i> Energizing</button>
                        <button type="button" class="mood-btn" data-mood="light"><i class="fas fa-leaf"></i> Light</button>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="checkbox-group">
                        <input type="checkbox" id="mpDietR" name="mpDietR">
                        <label for="mpDietR"><i class="fas fa-allergies"></i> Any Dietary Restrictions?</label>
                    </div>
                </div>
                
                <div id="dietaryDetails" style="display: none;">
                    <div class="form-group">
                        <label for="mpDietDetails"><i class="fas fa-info-circle"></i> Specify Restrictions</label>
                        <input type="text" id="mpDietDetails" name="mpDietDetails" placeholder="e.g., gluten-free, vegetarian, nut-free">
                    </div>
                </div>
                
                <button type="submit" id="btn-submit-create" class="btn-submit">
                    <i class="fas fa-magic"></i> Generate Meal Plan
                    <span id="loadingSpinner" class="loading" style="display: none;"></span>
                </button>
            </form>
            
            <!-- Action Buttons -->
            <div class="action-buttons-container" id="actionButtons" style="display: none;">
                <button id="btn-new-plan" class="btn-primary">
                    <i class="fas fa-calendar-plus"></i> Generate New Plan
                </button>
                <button id="btn-add-to-planner" class="btn-primary">
                    <i class="fas fa-calendar-check"></i> Save to Planner
                </button>
            </div>

            <!-- Daily Meal Card -->
            <div class="daily-meal-card" id="dailyMealCard" style="display: none;">
                <div class="daily-meal-header">
                    <h2 class="daily-meal-name" id="dailyMealName">Your Daily Meal</h2>
                    <div class="daily-meal-type">
                        <i class="fas fa-utensils"></i> 
                        <span id="dailyMealType">Dinner</span>
                    </div>
                </div>
                
                <div class="daily-meal-details">
                    <div class="daily-meal-meta">
                        <div class="daily-meta-item">
                            <div class="daily-meta-value" id="dailyPrepTime">0 min</div>
                            <div class="daily-meta-label">Prep Time</div>
                        </div>
                        <div class="daily-meta-item">
                            <div class="daily-meta-value" id="dailyCalories">0</div>
                            <div class="daily-meta-label">Calories</div>
                        </div>
                        <div class="daily-meta-item">
                            <div class="daily-meta-value" id="dailyCost">$0.00</div>
                            <div class="daily-meta-label">Cost</div>
                        </div>
                    </div>
                    
                    <p class="daily-meal-description" id="dailyMealDescription">
                        Your generated meal description will appear here.
                    </p>
                    
                    <div class="daily-meal-actions">
                        <button class="daily-action-btn" id="btn-new-daily">
                            <i class="fas fa-redo"></i> Generate Another
                        </button>
                        <button class="daily-action-btn" id="btn-add-to-calendar">
                            <i class="fas fa-calendar-plus"></i> Add to Calendar
                        </button>
                    </div>
                </div>
            </div>

            <!-- Weekly Plan -->
            <div class="weekly-plan" id="weeklyPlan" style="display: none;">
                <!-- Day cards will be populated by JavaScript -->
            </div>

            <!-- Weekly Summary -->
            <div class="weekly-summary" id="weeklySummary" style="display: none;">
                <div class="summary-card">
                    <i class="fas fa-dollar-sign"></i>
                    <div class="summary-value" id="costValue">$0.00</div>
                    <div class="summary-label">Estimated Cost</div>
                </div>
                <div class="summary-card">
                    <i class="fas fa-fire"></i>
                    <div class="summary-value" id="caloriesValue">0</div>
                    <div class="summary-label">Total Calories</div>
                </div>
                <div class="summary-card">
                    <i class="fas fa-clock"></i>
                    <div class="summary-value" id="prepTimeValue">0h 0m</div>
                    <div class="summary-label">Prep Time</div>
                </div>
                <div class="summary-card">
                    <i class="fas fa-carrot"></i>
                    <div class="summary-value" id="ingredientsValue">0</div>
                    <div class="summary-label">Unique Ingredients</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Meal Details Modal -->
    <div class="meal-modal" id="mealModal">
      <div class="modal-content">
        <button class="close-modal">&times;</button>
        <h2 class="modal-day-name" id="modalDayName">Monday</h2>
        <div class="modal-date" id="modalDate">Loading date...</div>
        <div class="modal-meals-container" id="modalMealsContainer"></div>
      </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://cnmapvrdamsugtdnuesh.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNubWFwdnJkYW1zdWd0ZG51ZXNoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTAyODYzMzYsImV4cCI6MjA2NTg2MjMzNn0.sLeHEQYRJSrCTDN7yi6zWSJ1Qb_6xtEZJzgJHeZfpo8';
        
        // Initialize Supabase client
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        // Global variables
        let currentPlan = null; // To store the current generated plan
        let currentUser = null; // To store the current user
        let isSignUp = false; // Track if we're in signup mode
        let userInventory = []; // Store user's inventory

        // Initialize the application
        document.addEventListener('DOMContentLoaded', async function() {
            // Check user session
            const { data: { user }, error } = await supabase.auth.getUser();
            if (user) {
                // User is logged in
                currentUser = user;
                document.getElementById('streakCount').textContent = '5';
                document.getElementById('authText').textContent = 'Logout';
                document.getElementById('mainContent').style.display = 'block';
                document.getElementById('authForm').style.display = 'none';
                
                // Load user inventory
                await loadUserInventory();
            } else {
                // User is not logged in
                document.getElementById('authForm').style.display = 'block';
                document.getElementById('mainContent').style.display = 'none';
                document.getElementById('authText').textContent = 'Login';
            }
            
            // Set up event listeners
            setupEventListeners();
            
            // Initialize UI components
            initDayCards();
            setupModal();
        });

        // Set up all event listeners
        function setupEventListeners() {
            // Authentication toggle
            document.getElementById('authToggleLink').addEventListener('click', function(e) {
                e.preventDefault();
                isSignUp = !isSignUp;
                
                if (isSignUp) {
                    this.textContent = 'Already have an account? Login';
                    document.getElementById('authSubmitBtn').innerHTML = '<i class="fas fa-user-plus"></i> Sign Up';
                    document.getElementById('authNameGroup').style.display = 'block';
                } else {
                    this.textContent = 'Don\'t have an account? Sign up';
                    document.getElementById('authSubmitBtn').innerHTML = '<i class="fas fa-sign-in-alt"></i> Login';
                    document.getElementById('authNameGroup').style.display = 'none';
                }
            });
            
            // Authentication button
            document.getElementById('authSubmitBtn').addEventListener('click', async function() {
                const email = document.getElementById('authEmail').value;
                const password = document.getElementById('authPassword').value;
                
                if (!email || !password) {
                    showToast('Please enter email and password', 'error');
                    return;
                }
                
                try {
                    if (isSignUp) {
                        const name = document.getElementById('authName').value || '';
                        const { data, error } = await supabase.auth.signUp({
                            email: email,
                            password: password,
                            options: {
                                data: {
                                    full_name: name,
                                    streak: 0
                                }
                            }
                        });
                        
                        if (error) throw error;
                        showToast('Sign up successful! Please check your email for confirmation.', 'success');
                    } else {
                        const { data, error } = await supabase.auth.signInWithPassword({
                            email: email,
                            password: password
                        });
                        
                        if (error) throw error;
                        currentUser = data.user;
                        document.getElementById('streakCount').textContent = '5';
                        document.getElementById('authText').textContent = 'Logout';
                        document.getElementById('mainContent').style.display = 'block';
                        document.getElementById('authForm').style.display = 'none';
                        
                        // Load user inventory
                        await loadUserInventory();
                        showToast('Login successful!', 'success');
                    }
                } catch (error) {
                    console.error('Authentication error:', error);
                    showToast(`Authentication failed: ${error.message}`, 'error');
                }
            });
            
            // Logout button
            document.getElementById('userAuthBtn').addEventListener('click', async function(e) {
                e.preventDefault();
                
                if (currentUser) {
                    // Logout
                    await supabase.auth.signOut();
                    currentUser = null;
                    document.getElementById('authText').textContent = 'Login';
                    document.getElementById('mainContent').style.display = 'none';
                    document.getElementById('authForm').style.display = 'block';
                    showToast('Logged out successfully', 'success');
                } else {
                    // Show login form
                    document.getElementById('mainContent').style.display = 'none';
                    document.getElementById('authForm').style.display = 'block';
                }
            });
            
            // Hamburger menu toggle
            document.getElementById('hamburgerMenu').addEventListener('click', function() {
                this.classList.toggle('active');
                document.querySelector('.nav-links').classList.toggle('active');
                document.body.style.overflow = this.classList.contains('active') ? 'hidden' : 'auto';
            });
            
            // Plan type toggle
            document.querySelectorAll('.plan-type-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.plan-type-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    const planType = this.dataset.planType;
                    
                    // Show/hide appropriate sections
                    document.getElementById('weeklyPlan').style.display = planType === 'weekly' ? 'grid' : 'none';
                    document.getElementById('weeklySummary').style.display = planType === 'weekly' ? 'grid' : 'none';
                    document.getElementById('dailyMealCard').style.display = planType === 'daily' ? 'block' : 'none';
                    document.getElementById('moodSelectorContainer').style.display = planType === 'daily' ? 'block' : 'none';
                    
                    // Update submit button text
                    const submitBtn = document.getElementById('btn-submit-create');
                    submitBtn.innerHTML = planType === 'weekly' 
                        ? '<i class="fas fa-magic"></i> Generate Meal Plan' 
                        : '<i class="fas fa-magic"></i> Generate Daily Meal';
                });
            });
            
            // Dietary restrictions toggle
            document.getElementById('mpDietR').addEventListener('change', function() {
                document.getElementById('dietaryDetails').style.display = 
                    this.checked ? 'block' : 'none';
            });
            
            // Mood selector buttons
            document.querySelectorAll('.mood-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.mood-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                });
            });
            
            // Inventory toggle
            document.getElementById('useInventory').addEventListener('change', function() {
                document.getElementById('inventoryItems').style.display = 
                    this.checked ? 'block' : 'none';
            });
            
            // Form submission
            document.getElementById('mealPlannerForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                if (!currentUser) {
                    showToast('Please log in to generate meal plans', 'error');
                    return;
                }
                
                const submitBtn = document.getElementById('btn-submit-create');
                const spinner = document.getElementById('loadingSpinner');
                
                submitBtn.disabled = true;
                spinner.style.display = 'inline-block';
                
                // Show loading overlay
                document.getElementById('loadingOverlay').classList.add('active');
                
                const planType = document.querySelector('.plan-type-btn.active').dataset.planType;
                const formData = {
                    planType: planType,
                    budget: document.getElementById('mpBudget').value,
                    specificFoods: document.getElementById('mpSpecific').value,
                    dietaryRestrictions: document.getElementById('mpDietR').checked ? 
                        document.getElementById('mpDietDetails').value : '',
                    useInventory: document.getElementById('useInventory').checked,
                    inventoryItems: userInventory,
                    mood: planType === 'daily' ? 
                        document.querySelector('.mood-btn.active').dataset.mood : ''
                };
                
                try {
                    // Generate meal plan
                    const response = await generateMealPlan(formData);
                    
                    // Store the current plan
                    currentPlan = {
                        type: planType,
                        data: planType === 'weekly' ? {
                            plan: response.plan,
                            summary: response.summary
                        } : response
                    };
                    
                    if (planType === 'weekly') {
                        // Update weekly plan
                        updateDayCards(response.plan);
                        updateWeeklySummary(response.summary);
                        document.getElementById('weeklyPlan').style.display = 'grid';
                        document.getElementById('weeklySummary').style.display = 'grid';
                        document.getElementById('dailyMealCard').style.display = 'none';
                        showToast('Weekly meal plan generated successfully!', 'success');
                    } else {
                        // Update daily meal
                        displayDailyMeal(response);
                        document.getElementById('weeklyPlan').style.display = 'none';
                        document.getElementById('weeklySummary').style.display = 'none';
                        showToast('Daily meal generated successfully!', 'success');
                    }
                    
                    // Show action buttons
                    document.getElementById('actionButtons').style.display = 'flex';
                } catch (error) {
                    console.error('Error generating meal plan:', error);
                    showToast(`Error: ${error.message}`, 'error');
                } finally {
                    submitBtn.disabled = false;
                    spinner.style.display = 'none';
                    document.getElementById('loadingOverlay').classList.remove('active');
                }
            });
            
            // Action buttons
            document.getElementById('btn-new-plan').addEventListener('click', function() {
                document.getElementById('mealPlannerForm').dispatchEvent(new Event('submit'));
            });
            
            document.getElementById('btn-new-daily').addEventListener('click', function() {
                document.getElementById('mealPlannerForm').dispatchEvent(new Event('submit'));
            });
            
            document.getElementById('btn-add-to-planner').addEventListener('click', saveMealPlanToDatabase);
            
            document.getElementById('btn-add-to-calendar').addEventListener('click', function() {
                showToast('Daily meal added to your calendar!', 'success');
            });
        }

        // Load user inventory from Supabase
        async function loadUserInventory() {
            if (!currentUser) return;
            
            try {
                const { data, error } = await supabase
                    .from('inventory')
                    .select('*')
                    .eq('user_id', currentUser.id);
                
                if (error) throw error;
                
                userInventory = data || [];
                displayInventoryItems(userInventory);
            } catch (error) {
                console.error('Error loading inventory:', error);
                showToast('Failed to load inventory', 'error');
            }
        }
        
        // Display inventory items
        function displayInventoryItems(items) {
            const container = document.getElementById('inventoryItems');
            container.innerHTML = '';
            
            if (items.length === 0) {
                container.innerHTML = '<div class="inventory-item">No items in inventory</div>';
                return;
            }
            
            items.forEach(item => {
                const itemEl = document.createElement('div');
                itemEl.className = 'inventory-item';
                
                // Calculate expiry status
                let expiryClass = '';
                let expiryText = 'No expiry';
                if (item.expiry_date) {
                    const today = new Date();
                    const expiryDate = new Date(item.expiry_date);
                    const diffDays = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));
                    
                    if (diffDays < 0) {
                        expiryClass = 'expired';
                        expiryText = 'Expired';
                    } else if (diffDays <= 3) {
                        expiryClass = 'expiring-soon';
                        expiryText = `Expires in ${diffDays} days`;
                    } else {
                        expiryClass = 'fresh';
                        expiryText = `Expires in ${diffDays} days`;
                    }
                }
                
                itemEl.innerHTML = `
                    <div>
                        <span>${item.name} (${item.quantity} ${item.unit})</span>
                        <span class="item-expiry ${expiryClass}">${expiryText}</span>
                    </div>
                `;
                container.appendChild(itemEl);
            });
        }
        
        // Function to save meal plan to database
        async function saveMealPlanToDatabase() {
            if (!currentPlan || !currentUser) {
                showToast('No meal plan to save or user not logged in', 'error');
                return;
            }

            // Show loading overlay
            document.getElementById('loadingOverlay').classList.add('active');

            try {
                // Prepare plan data
                const planData = {
                    plan_type: currentPlan.type,
                    plan_data: currentPlan.data,
                    user_id: currentUser.id,
                    start_date: new Date().toISOString(),
                    end_date: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString()
                };

                // Save to database
                const { error } = await supabase
                    .from('meal_plans')
                    .insert(planData);

                if (error) throw error;

                showToast('Meal plan saved successfully!', 'success');
                
                // Update streak
                document.getElementById('streakCount').textContent = 
                    parseInt(document.getElementById('streakCount').textContent) + 1;
            } catch (error) {
                console.error('Error saving meal plan:', error);
                showToast(`Failed to save: ${error.message}`, 'error');
            } finally {
                document.getElementById('loadingOverlay').classList.remove('active');
            }
        }

        // Initialize day cards for weekly view
        function initDayCards() {
            const weeklyPlan = document.getElementById('weeklyPlan');
            weeklyPlan.innerHTML = '';
            
            const daysOfWeek = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
            
            daysOfWeek.forEach((day, index) => {
                const card = document.createElement('div');
                card.className = 'day-card';
                if (index === 0) card.classList.add('today');
                
                card.dataset.dayName = day;
                
                card.innerHTML = `
                    <div class="day-header">
                        <div class="day-name">${day}</div>
                        <div class="date">${getDateString(index)}</div>
                    </div>
                    <div class="meal-container">
                        <div class="empty-state">No meals planned</div>
                    </div>
                `;
                
                weeklyPlan.appendChild(card);
            });
        }
        
        // Helper function to get date string
        function getDateString(dayOffset) {
            const today = new Date();
            const date = new Date(today);
            date.setDate(today.getDate() + dayOffset);
            
            return date.toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric' 
            });
        }
        
        // Update day cards with meal data
        function updateDayCards(weeklyPlan) {
            const dayCards = document.querySelectorAll('.day-card');
            
            dayCards.forEach(card => {
                const dayName = card.dataset.dayName;
                const mealContainer = card.querySelector('.meal-container');
                mealContainer.innerHTML = '';
                
                if (weeklyPlan[dayName] && weeklyPlan[dayName].length > 0) {
                    card.dataset.meals = JSON.stringify(weeklyPlan[dayName]);
                    
                    weeklyPlan[dayName].forEach(meal => {
                        const mealElement = document.createElement('div');
                        mealElement.className = 'meal-item';
                        
                        mealElement.innerHTML = `<strong>${meal.type}:</strong> ${meal.name}`;
                        mealContainer.appendChild(mealElement);
                    });
                } else {
                    mealContainer.innerHTML = '<div class="empty-state">No meals planned</div>';
                    card.dataset.meals = '[]';
                }
            });
        }
        
        // Update weekly summary
        function updateWeeklySummary(summaryData) {
            document.getElementById('costValue').textContent = `$${summaryData.totalCost}`;
            document.getElementById('caloriesValue').textContent = summaryData.totalCalories;
            document.getElementById('prepTimeValue').textContent = summaryData.totalPrepTime;
            document.getElementById('ingredientsValue').textContent = summaryData.uniqueIngredients;
        }
        
        // Display daily meal
        function displayDailyMeal(mealData) {
            if (!mealData) return;
            
            document.getElementById('dailyMealName').textContent = mealData.name || 'Unnamed Meal';
            document.getElementById('dailyMealType').textContent = mealData.type || 'Meal';
            document.getElementById('dailyPrepTime').textContent = mealData.prepTime || 'N/A';
            document.getElementById('dailyCalories').textContent = mealData.calories || 'N/A';
            document.getElementById('dailyCost').textContent = mealData.cost || 'N/A';
            document.getElementById('dailyMealDescription').textContent = mealData.description || 'No description available.';
            
            // Show the daily meal card
            document.getElementById('dailyMealCard').style.display = 'block';
        }
        
        // Set up the meal details modal
        function setupModal() {
            const modal = document.getElementById('mealModal');
            const closeModal = document.querySelector('.close-modal');
            
            // Event delegation for day cards
            document.getElementById('weeklyPlan').addEventListener('click', function(event) {
                const card = event.target.closest('.day-card');
                if (!card) return;
                
                const meals = JSON.parse(card.dataset.meals || '[]');
                
                document.getElementById('modalDayName').textContent = card.dataset.dayName;
                document.getElementById('modalDate').textContent = getDateString(Array.from(card.parentNode.children).indexOf(card));
                
                const container = document.getElementById('modalMealsContainer');
                container.innerHTML = '';
                
                if (meals.length > 0) {
                    meals.forEach(meal => {
                        const mealDiv = document.createElement('div');
                        mealDiv.className = 'modal-meal-item';
                        
                        mealDiv.innerHTML = `
                            <div class="meal-header">
                                <div class="meal-type">
                                    <i class="fas fa-utensils"></i> ${meal.type}: ${meal.name}
                                </div>
                                <button class="meal-toggle">
                                    <i class="fas fa-chevron-down"></i>
                                </button>
                            </div>
                            <div class="meal-description">${meal.description}</div>
                            <div class="meal-meta">
                                <span class="prep-time"><i class="fas fa-clock"></i> Prep: ${meal.prepTime}</span>
                                <span class="calories"><i class="fas fa-fire"></i> Calories: ${meal.calories}</span>
                            </div>
                            <div class="meal-details">
                                <div class="details-section">
                                    <h5><i class="fas fa-carrot"></i> Ingredients</h5>
                                    <ul class="ingredients-list">
                                        ${meal.ingredients ? meal.ingredients.map(ing => 
                                            `<li>${ing} <span class="inventory-status ${userInventory.some(item => 
                                                item.name.toLowerCase().includes(ing.toLowerCase().split(' ')[0])) ? 
                                                'available' : 'missing'}">${userInventory.some(item => 
                                                item.name.toLowerCase().includes(ing.toLowerCase().split(' ')[0])) ? 
                                                'In stock' : 'Missing'}</span></li>`
                                        ).join('') : '<li>No ingredients listed</li>'}
                                    </ul>
                                </div>
                                <div class="details-section">
                                    <h5><i class="fas fa-list-ol"></i> Preparation Steps</h5>
                                    <ol class="steps-list">
                                        ${meal.steps ? meal.steps.map((step, i) => 
                                            `<li>${step}</li>`
                                        ).join('') : '<li>No steps provided</li>'}
                                    </ol>
                                </div>
                                <div class="meal-actions">
                                    <button class="meal-action-btn primary add-to-grocery-btn">
                                        <i class="fas fa-cart-plus"></i> Add Missing to Grocery
                                    </button>
                                    <button class="meal-action-btn secondary smart-swap-btn">
                                        <i class="fas fa-sync-alt"></i> Smart Swap
                                    </button>
                                    <button class="meal-action-btn secondary">
                                        <i class="fas fa-share-alt"></i> Share
                                    </button>
                                </div>
                                <div class="meal-rating">
                                    <span>Rate this meal:</span>
                                    <div class="stars">
                                        <i class="fas fa-star rating-star" data-value="1"></i>
                                        <i class="fas fa-star rating-star" data-value="2"></i>
                                        <i class="fas fa-star rating-star" data-value="3"></i>
                                        <i class="fas fa-star rating-star" data-value="4"></i>
                                        <i class="fas fa-star rating-star" data-value="5"></i>
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        container.appendChild(mealDiv);
                    });
                } else {
                    container.innerHTML = '<div class="empty-state">No meals planned for this day</div>';
                }
                
                // Set up toggle buttons
                document.querySelectorAll('.meal-toggle').forEach(toggle => {
                    toggle.addEventListener('click', function() {
                        const details = this.closest('.modal-meal-item').querySelector('.meal-details');
                        const icon = this.querySelector('i');
                        
                        details.classList.toggle('expanded');
                        
                        if (details.classList.contains('expanded')) {
                            icon.classList.remove('fa-chevron-down');
                            icon.classList.add('fa-chevron-up');
                        } else {
                            icon.classList.remove('fa-chevron-up');
                            icon.classList.add('fa-chevron-down');
                        }
                    });
                });
                
                // Set up rating stars
                document.querySelectorAll('.rating-star').forEach(star => {
                    star.addEventListener('click', function() {
                        const value = parseInt(this.dataset.value);
                        const stars = this.parentElement.querySelectorAll('.rating-star');
                        
                        stars.forEach((s, i) => {
                            if (i < value) {
                                s.classList.add('active');
                            } else {
                                s.classList.remove('active');
                            }
                        });
                        
                        showToast(`Rated ${value} stars!`, 'success');
                    });
                    
                    // Add hover effect
                    star.addEventListener('mouseover', function() {
                        const value = parseInt(this.dataset.value);
                        const stars = this.parentElement.querySelectorAll('.rating-star');
                        
                        stars.forEach((s, i) => {
                            if (i < value) {
                                s.classList.add('hover');
                            } else {
                                s.classList.remove('hover');
                            }
                        });
                    });
                    
                    star.addEventListener('mouseout', function() {
                        const stars = this.parentElement.querySelectorAll('.rating-star');
                        stars.forEach(s => s.classList.remove('hover'));
                    });
                });
                
                // Set up action buttons
                document.querySelectorAll('.add-to-grocery-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        showToast('Missing ingredients added to grocery list!', 'success');
                    });
                });
                
                document.querySelectorAll('.smart-swap-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        showToast('Finding alternative meals using your inventory...', 'success');
                    });
                });
                
                modal.classList.add('active');
                document.body.style.overflow = 'hidden';
            });
            
            closeModal.addEventListener('click', function() {
                modal.classList.remove('active');
                document.body.style.overflow = 'auto';
            });
            
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.classList.remove('active');
                    document.body.style.overflow = 'auto';
                }
            });
        }
        
        // Generate meal plan using OpenAI API via Supabase Edge Function
        async function generateMealPlan(formData) {
            try {
                // In a real application, this would call your Supabase Edge Function
                // For this demo, we'll generate mock data based on form inputs
                return generateMockMealPlan(formData);
            } catch (error) {
                console.error('Error in generateMealPlan:', error);
                throw error;
            }
        }
        
        // Generate mock meal plan based on form data
        function generateMockMealPlan(formData) {
            const { planType, budget, specificFoods, dietaryRestrictions, useInventory, inventoryItems, mood } = formData;
            
            if (planType === 'daily') {
                // Generate daily meal
                const meals = [
                    {
                        name: "Mediterranean Chicken Bowl",
                        type: "Dinner",
                        prepTime: "30 min",
                        calories: 520,
                        cost: "$5.25",
                        description: "A delicious bowl featuring grilled chicken, quinoa, fresh vegetables, olives, and feta cheese with a tangy lemon-herb dressing.",
                        ingredients: [
                            "Chicken breast (200g)",
                            "Quinoa (1 cup)",
                            "Cherry tomatoes (100g)",
                            "Cucumber (1/2)",
                            "Feta cheese (50g)",
                            "Kalamata olives (10)",
                            "Lemon (1)",
                            "Olive oil (1 tbsp)",
                            "Fresh herbs"
                        ],
                        steps: [
                            "Cook quinoa according to package instructions and let cool",
                            "Season chicken breast with salt, pepper, and herbs, then grill until cooked through",
                            "Chop vegetables and olives",
                            "Prepare dressing by whisking lemon juice, olive oil, and herbs",
                            "Assemble bowls with quinoa, sliced chicken, vegetables, and olives",
                            "Drizzle with dressing and top with crumbled feta cheese"
                        ]
                    },
                    {
                        name: "Vegetable Stir Fry with Tofu",
                        type: "Dinner",
                        prepTime: "25 min",
                        calories: 450,
                        cost: "$4.75",
                        description: "A quick and nutritious stir fry with crispy tofu and seasonal vegetables in a savory sauce.",
                        ingredients: [
                            "Firm tofu (200g)",
                            "Broccoli (1 cup)",
                            "Bell peppers (2)",
                            "Carrots (2)",
                            "Soy sauce (2 tbsp)",
                            "Ginger (1 tsp)",
                            "Garlic (2 cloves)",
                            "Sesame oil (1 tsp)",
                            "Rice (1 cup)"
                        ],
                        steps: [
                            "Press tofu to remove excess water, then cube and pan-fry until golden",
                            "Chop vegetables into bite-sized pieces",
                            "Stir-fry vegetables in sesame oil with ginger and garlic",
                            "Add tofu and soy sauce, cook for 5 more minutes",
                            "Serve over cooked rice"
                        ]
                    }
                ];
                
                return meals[Math.floor(Math.random() * meals.length)];
            } else {
                // Generate weekly plan
                const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
                const mealTypes = ['Breakfast', 'Lunch', 'Dinner'];
                const mealNames = [
                    "Oatmeal with Berries", 
                    "Quinoa Salad", 
                    "Grilled Salmon", 
                    "Vegetable Stir Fry", 
                    "Chicken Wrap", 
                    "Pasta Primavera", 
                    "Bean Chili", 
                    "Greek Yogurt Parfait"
                ];
                
                const plan = {};
                days.forEach(day => {
                    plan[day] = mealTypes.map(type => {
                        const name = mealNames[Math.floor(Math.random() * mealNames.length)];
                        return {
                            name: name,
                            type: type,
                            prepTime: `${10 + Math.floor(Math.random() * 30)} min`,
                            calories: 300 + Math.floor(Math.random() * 400),
                            description: `A delicious ${type.toLowerCase()} featuring ${name.toLowerCase()}`
                        };
                    });
                });
                
                const summary = {
                    totalCost: (budget * 0.8).toFixed(2),
                    totalCalories: Math.floor(2000 * 7 * 0.9),
                    totalPrepTime: "6h 45m",
                    uniqueIngredients: 35
                };
                
                return { plan, summary };
            }
        }
        
        // Show toast notification
        function showToast(message, type = '') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast';
            
            if (type) {
                toast.classList.add(type);
            }
            
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
    </script>
</body>
</html>
