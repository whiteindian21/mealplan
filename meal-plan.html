<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Savory Meal Planner</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* Enhanced CSS styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
            min-height: 100vh;
            padding: 20px;
            position: relative;
            overflow-x: hidden;
            color: #2c3e50;
        }
        
        .floating-element {
            position: absolute;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            z-index: -1;
            animation: float 15s infinite ease-in-out;
        }
        
        @keyframes float {
            0%, 100% { transform: translate(0, 0); }
            25% { transform: translate(10px, 15px); }
            50% { transform: translate(-10px, 20px); }
            75% { transform: translate(15px, -10px); }
        }
        
        .floating-element:nth-child(1) {
            width: 300px;
            height: 300px;
            top: -100px;
            right: -100px;
            background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%);
            animation-duration: 18s;
        }
        
        .floating-element:nth-child(2) {
            width: 200px;
            height: 200px;
            bottom: 50px;
            left: -50px;
            background: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%);
            animation-duration: 22s;
        }
        
        .floating-element:nth-child(3) {
            width: 150px;
            height: 150px;
            top: 200px;
            left: 150px;
            background: linear-gradient(135deg, #d4fc79 0%, #96e6a1 100%);
            animation-duration: 25s;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }
        
        /* Navigation */
        nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 15px 30px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
        }
        
        .logo {
            display: flex;
            align-items: center;
            font-size: 28px;
            font-weight: 700;
            color: #2c3e50;
            font-family: 'Dancing Script', cursive;
        }
        
        .logo i {
            margin-right: 10px;
            color: #e67e22;
        }
        
        .nav-links {
            display: flex;
            gap: 25px;
        }
        
        .nav-links a {
            text-decoration: none;
            color: #34495e;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            padding: 8px 15px;
            border-radius: 50px;
        }
        
        .nav-links a:hover {
            color: #e67e22;
            background: rgba(230, 126, 34, 0.1);
        }
        
        .nav-links a i {
            font-size: 18px;
        }
        
        .user-section {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .streak-container {
            background: #fff;
            border-radius: 50px;
            padding: 8px 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            font-weight: 500;
            transition: transform 0.3s;
        }
        
        .streak-container:hover {
            transform: scale(1.05);
        }
        
        .streak-container i {
            color: #e74c3c;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        .hamburger-menu {
            display: none;
            flex-direction: column;
            gap: 5px;
            cursor: pointer;
            padding: 10px;
            border-radius: 8px;
            background: rgba(230, 126, 34, 0.1);
        }
        
        .hamburger-menu span {
            width: 25px;
            height: 3px;
            background: #2c3e50;
            border-radius: 2px;
            transition: all 0.3s;
        }
        
        .hamburger-menu.active span:nth-child(1) {
            transform: rotate(45deg) translate(5px, 5px);
        }
        
        .hamburger-menu.active span:nth-child(2) {
            opacity: 0;
        }
        
        .hamburger-menu.active span:nth-child(3) {
            transform: rotate(-45deg) translate(5px, -5px);
        }
        
        .main-heading {
            text-align: center;
            font-size: 42px;
            color: #2c3e50;
            margin-bottom: 40px;
            font-weight: 700;
            position: relative;
            display: inline-block;
            width: 100%;
        }
        
        .main-heading::after {
            content: '';
            display: block;
            width: 100px;
            height: 4px;
            background: linear-gradient(to right, #e67e22, #e74c3c);
            margin: 15px auto 0;
            border-radius: 2px;
        }
        
        /* Plan Type Toggle */
        .plan-type-toggle {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .plan-type-btn {
            padding: 12px 25px;
            border: none;
            background: #ecf0f1;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        
        .plan-type-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
        }
        
        .plan-type-btn.active {
            background: #e67e22;
            color: white;
            box-shadow: 0 4px 15px rgba(230, 126, 34, 0.4);
        }
        
        /* Forms */
        .forms {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
        }
        
        .forms::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 5px;
            height: 100%;
            background: linear-gradient(to bottom, #e67e22, #e74c3c);
        }
        
        .inventory-toggle {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .inventory-toggle label {
            font-weight: 500;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 17px;
            cursor: pointer;
        }
        
        .inventory-toggle i {
            color: #e67e22;
            font-size: 20px;
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: #27ae60;
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }
        
        .inventory-items {
            background: #f9f9f9;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            display: none;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #eee;
        }
        
        .inventory-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid #eee;
            align-items: center;
        }
        
        .inventory-item:last-child {
            border-bottom: none;
        }
        
        .item-expiry {
            font-size: 13px;
            padding: 3px 8px;
            border-radius: 20px;
            background: #f1f2f6;
            font-weight: 500;
        }
        
        .expiring-soon {
            background: #fef9e7;
            color: #d35400;
        }
        
        .expired {
            background: #fadbd8;
            color: #c0392b;
        }
        
        .fresh {
            background: #d5f5e3;
            color: #27ae60;
        }
        
        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-group {
            flex: 1;
            position: relative;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .form-group i {
            color: #e67e22;
        }
        
        .form-group input {
            width: 100%;
            padding: 14px;
            border: 1px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #f9f9f9;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #e67e22;
            box-shadow: 0 0 0 3px rgba(230, 126, 34, 0.2);
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .checkbox-group input {
            width: 20px;
            height: 20px;
            accent-color: #e67e22;
            cursor: pointer;
        }
        
        .checkbox-group label {
            font-weight: 500;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }
        
        .checkbox-group i {
            color: #e67e22;
        }
        
        .mood-selector {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .mood-btn {
            padding: 12px 18px;
            border: none;
            background: #f1f2f6;
            border-radius: 10px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .mood-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        
        .mood-btn.active {
            background: #3498db;
            color: white;
            box-shadow: 0 4px 10px rgba(52, 152, 219, 0.3);
        }
        
        .btn-submit {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #e67e22 0%, #e74c3c 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 15px rgba(231, 126, 34, 0.4);
            position: relative;
            overflow: hidden;
        }
        
        .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(231, 126, 34, 0.5);
        }
        
        .btn-submit::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -60%;
            width: 20px;
            height: 200%;
            background: rgba(255,255,255,0.3);
            transform: rotate(25deg);
            transition: all 0.6s;
        }
        
        .btn-submit:hover::after {
            left: 120%;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Action Buttons */
        .action-buttons-container {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 25px 0;
            width: 100%;
        }
        
        .btn-primary {
            padding: 14px 25px;
            border: none;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            position: relative;
            overflow: hidden;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(44, 62, 80, 0.2);
        }
        
        .btn-primary::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -60%;
            width: 20px;
            height: 200%;
            background: rgba(255,255,255,0.2);
            transform: rotate(25deg);
            transition: all 0.6s;
        }
        
        .btn-primary:hover::after {
            left: 120%;
        }
        
        .btn-outline {
            background: transparent;
            border: 2px solid #2c3e50;
            color: #2c3e50;
        }
        
        /* Daily Meal Card */
        .daily-meal-card {
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            display: none;
            animation: fadeIn 0.5s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .daily-meal-header {
            background: linear-gradient(135deg, #e67e22 0%, #e74c3c 100%);
            padding: 25px;
            color: white;
            position: relative;
        }
        
        .daily-meal-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: rgba(255,255,255,0.3);
        }
        
        .daily-meal-name {
            font-size: 28px;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .daily-meal-type {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 18px;
            opacity: 0.9;
        }
        
        .daily-meal-details {
            padding: 25px;
        }
        
        .daily-meal-meta {
            display: flex;
            justify-content: space-between;
            margin-bottom: 25px;
            gap: 15px;
        }
        
        .daily-meta-item {
            text-align: center;
            flex: 1;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        
        .daily-meta-value {
            font-size: 24px;
            font-weight: 700;
            color: #e67e22;
            margin-bottom: 5px;
        }
        
        .daily-meta-label {
            color: #7f8c8d;
            font-size: 14px;
        }
        
        .daily-meal-description {
            color: #34495e;
            line-height: 1.6;
            margin-bottom: 25px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 10px;
        }
        
        .daily-meal-actions {
            display: flex;
            gap: 15px;
        }
        
        .daily-action-btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        
        .daily-action-btn:first-child {
            background: #ecf0f1;
            color: #2c3e50;
        }
        
        .daily-action-btn:first-child:hover {
            background: #e0e5e9;
        }
        
        .daily-action-btn:last-child {
            background: #3498db;
            color: white;
        }
        
        .daily-action-btn:last-child:hover {
            background: #2980b9;
        }
        
        /* Weekly Plan */
        .weekly-plan {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
            display: none;
        }
        
        .day-card {
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
            animation: fadeIn 0.5s ease-out;
        }
        
        .day-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
        }
        
        .day-card.today .day-header {
            background: linear-gradient(135deg, #3498db 0%, #1abc9c 100%);
        }
        
        .day-header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            padding: 20px;
            color: white;
            position: relative;
        }
        
        .day-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: rgba(255,255,255,0.3);
        }
        
        .day-name {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .date {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .meal-container {
            padding: 20px;
        }
        
        .meal-item {
            padding: 12px 0;
            border-bottom: 1px solid #eee;
            transition: background 0.3s;
        }
        
        .meal-item:hover {
            background: #f9f9f9;
        }
        
        .meal-item:last-child {
            border-bottom: none;
        }
        
        /* Weekly Summary */
        .weekly-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
            display: none;
            animation: fadeIn 0.5s ease-out;
        }
        
        .summary-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s;
        }
        
        .summary-card:hover {
            transform: translateY(-5px);
        }
        
        .summary-card i {
            font-size: 36px;
            margin-bottom: 15px;
            color: #e67e22;
        }
        
        .summary-value {
            font-size: 28px;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .summary-label {
            color: #7f8c8d;
            font-size: 14px;
        }
        
        /* Modal */
        .meal-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .meal-modal.active {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            background: white;
            border-radius: 20px;
            width: 90%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 30px;
            position: relative;
            animation: modalIn 0.4s ease-out;
        }
        
        @keyframes modalIn {
            from { opacity: 0; transform: translateY(50px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .close-modal {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #7f8c8d;
            transition: color 0.3s ease;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }
        
        .close-modal:hover {
            color: #e74c3c;
            background: #f9f9f9;
        }
        
        .modal-day-name {
            font-size: 24px;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .modal-date {
            color: #7f8c8d;
            margin-bottom: 20px;
        }
        
        .modal-meal-item {
            background: #f9f9f9;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #e67e22;
        }
        
        .meal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .meal-type {
            font-weight: 600;
            font-size: 18px;
            color: #2c3e50;
        }
        
        .meal-toggle {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: #7f8c8d;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }
        
        .meal-toggle:hover {
            background: #eee;
        }
        
        .meal-description {
            color: #34495e;
            margin-bottom: 15px;
            line-height: 1.5;
        }
        
        .meal-meta {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            font-size: 14px;
            color: #7f8c8d;
            flex-wrap: wrap;
        }
        
        .meal-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        
        .meal-details.expanded {
            max-height: 1000px;
        }
        
        .details-section {
            margin-bottom: 20px;
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
        }
        
        .details-section h5 {
            font-size: 16px;
            color: #2c3e50;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
        }
        
        .ingredients-list, .steps-list {
            padding-left: 20px;
        }
        
        .ingredients-list li, .steps-list li {
            margin-bottom: 8px;
            color: #34495e;
            position: relative;
            padding-left: 10px;
        }
        
        .ingredients-list li::before {
            content: '•';
            position: absolute;
            left: 0;
            color: #e67e22;
        }
        
        .steps-list li {
            counter-increment: step-counter;
            margin-bottom: 15px;
        }
        
        .steps-list li::before {
            content: counter(step-counter);
            background: #e67e22;
            color: white;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            margin-right: 10px;
        }
        
        .inventory-status {
            font-size: 12px;
            padding: 3px 8px;
            border-radius: 20px;
            margin-left: 8px;
            background: #f1f2f6;
            font-weight: 500;
        }
        
        .inventory-status.missing {
            background: #fadbd8;
            color: #c0392b;
        }
        
        .inventory-status.available {
            background: #d5f5e3;
            color: #27ae60;
        }
        
        .meal-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .meal-action-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            min-width: 150px;
        }
        
        .meal-action-btn.primary {
            background: #3498db;
            color: white;
        }
        
        .meal-action-btn.primary:hover {
            background: #2980b9;
        }
        
        .meal-action-btn.secondary {
            background: #ecf0f1;
            color: #2c3e50;
        }
        
        .meal-action-btn.secondary:hover {
            background: #e0e5e9;
        }
        
        .meal-rating {
            margin-top: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .stars {
            display: flex;
            gap: 5px;
        }
        
        .rating-star {
            color: #ddd;
            cursor: pointer;
            transition: color 0.3s ease;
            font-size: 20px;
        }
        
        .rating-star.hover {
            color: #f1c40f;
        }
        
        .rating-star.active {
            color: #f1c40f;
        }
        
        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #2c3e50;
            color: white;
            padding: 15px 25px;
            border-radius: 50px;
            font-weight: 500;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 2000;
        }
        
        .toast.show {
            opacity: 1;
            visibility: visible;
            animation: toastIn 0.5s, toastOut 0.5s 2.5s;
        }
        
        @keyframes toastIn {
            from { bottom: -50px; opacity: 0; }
            to { bottom: 20px; opacity: 1; }
        }
        
        @keyframes toastOut {
            from { bottom: 20px; opacity: 1; }
            to { bottom: -50px; opacity: 0; }
        }
        
        .toast.success {
            background: #27ae60;
        }
        
        .toast.error {
            background: #e74c3c;
        }
        
        .toast.warning {
            background: #f39c12;
        }
        
        /* Responsive */
        @media (max-width: 900px) {
            .nav-links {
                position: fixed;
                top: 0;
                right: -300px;
                width: 300px;
                height: 100%;
                background: white;
                flex-direction: column;
                padding: 80px 20px 20px;
                box-shadow: -5px 0 15px rgba(0,0,0,0.1);
                transition: right 0.3s ease;
                z-index: 100;
            }
            
            .nav-links.active {
                right: 0;
            }
            
            .nav-links a {
                width: 100%;
                padding: 12px 20px;
                border-radius: 8px;
            }
            
            .hamburger-menu {
                display: flex;
                z-index: 101;
            }
            
            .form-row {
                flex-direction: column;
                gap: 15px;
            }
            
            .daily-meal-meta {
                flex-direction: column;
            }
            
            .weekly-plan {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 600px) {
            .daily-meal-actions {
                flex-direction: column;
            }
            
            .action-buttons-container {
                flex-direction: column;
            }
            
            .meal-actions {
                flex-direction: column;
            }
            
            .main-heading {
                font-size: 32px;
            }
            
            .logo {
                font-size: 24px;
            }
            
            .streak-container {
                padding: 6px 12px;
                font-size: 14px;
            }
            
            .plan-type-btn {
                padding: 10px 15px;
                font-size: 14px;
            }
        }
        
        /* Empty state styling */
        .empty-state {
            text-align: center;
            padding: 30px;
            color: #7f8c8d;
        }
        
        .empty-state i {
            font-size: 48px;
            margin-bottom: 15px;
            color: #bdc3c7;
        }
        
        /* Loading overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }
        
        .loading-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(230, 126, 34, 0.2);
            border-top: 5px solid #e67e22;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body>
    <!-- Floating decorative elements -->
    <div class="floating-element"></div>
    <div class="floating-element"></div>
    <div class="floating-element"></div>

    <!-- Loading overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <div class="container">
        <!-- Navigation -->
        <nav>
            <div class="logo">
                <i class="fas fa-utensils"></i>
                Savory
            </div>
            <div class="nav-links">
                <a href="planner.html"><i class="fas fa-calendar-alt"></i> Planner</a>
                <a href="inventory.html"><i class="fas fa-box-open"></i> Inventory</a>
                <a href="grocery.html"><i class="fas fa-shopping-basket"></i> Grocery</a>
                <a href="setting.html"><i class="fas fa-cog"></i> Settings</a>
                <div class="user-section">
                    <div class="streak-container" id="streakContainer">
                        <i class="fas fa-fire"></i> <span id="streakCount">0</span> Day Streak
                    </div>
                    <a href="#" id="userAuthBtn"><i class="fas fa-user"></i> <span id="authText">Login</span></a>
                </div>
            </div>
            <div class="hamburger-menu" id="hamburgerMenu">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </nav>

        <!-- Login/Signup Form -->
        <div class="forms" id="authForm" style="display: none;">
            <h2 class="main-heading">Welcome to Savory</h2>
            <div class="form-group">
                <label for="authEmail"><i class="fas fa-envelope"></i> Email</label>
                <input type="email" id="authEmail" name="authEmail" placeholder="Enter your email" required>
            </div>
            <div class="form-group">
                <label for="authPassword"><i class="fas fa-lock"></i> Password</label>
                <input type="password" id="authPassword" name="authPassword" placeholder="Enter your password" required>
            </div>
            <div class="form-group" id="authNameGroup" style="display: none;">
                <label for="authName"><i class="fas fa-user"></i> Full Name</label>
                <input type="text" id="authName" name="authName" placeholder="Enter your full name">
            </div>
            <button type="button" id="authSubmitBtn" class="btn-submit">
                <i class="fas fa-sign-in-alt"></i> Login
            </button>
            <div class="form-group" style="text-align: center; margin-top: 15px;">
                <a href="#" id="authToggleLink">Don't have an account? Sign up</a>
            </div>
        </div>

        <!-- Main Content - Visible only when logged in -->
        <div id="mainContent" style="display: none;">
            <h1 class="main-heading">Plan Your Meals</h1>
            
            <!-- Plan Type Toggle -->
            <div class="plan-type-toggle">
                <button class="plan-type-btn active" data-plan-type="weekly">
                    <i class="fas fa-calendar-week"></i> Weekly Plan
                </button>
                <button class="plan-type-btn" data-plan-type="daily">
                    <i class="fas fa-sun"></i> Daily Meal
                </button>
            </div>

            <!-- Meal Planner Form -->
            <form id="mealPlannerForm" class="forms">
                <!-- Inventory Toggle Section -->
                <div class="inventory-toggle">
                    <label for="useInventory">
                        <i class="fas fa-box-open"></i> Generate meals using my inventory
                    </label>
                    <div class="toggle-switch">
                        <input type="checkbox" id="useInventory" name="useInventory">
                        <span class="toggle-slider"></span>
                    </div>
                </div>
                
                <div class="inventory-items" id="inventoryItems">
                    <!-- Inventory items will be populated dynamically -->
                    <div class="inventory-item">
                        <div>
                            <span>Loading inventory...</span>
                        </div>
                    </div>
                </div>
                
                <div class="form-row">
                    <!-- Weekly Budget (only for weekly plan) -->
                    <div class="form-group" id="weeklyBudgetGroup">
                        <label for="mpBudget"><i class="fas fa-wallet"></i> Weekly Budget ($)</label>
                        <input type="number" id="mpBudget" name="mpBudget" min="50" step="10" value="150" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="mpSpecific"><i class="fas fa-apple-alt"></i> Specific Foods To Include</label>
                        <input type="text" id="mpSpecific" name="mpSpecific" placeholder="e.g., chicken, broccoli, quinoa">
                    </div>
                </div>
                
                <!-- Mood Selector - Hidden by default, shown only for daily plan -->
                <div class="form-group" id="moodSelectorContainer" style="display: none;">
                    <label><i class="fas fa-heart"></i> Meal Mood</label>
                    <div class="mood-selector">
                        <button type="button" class="mood-btn active" data-mood="any"><i class="fas fa-question"></i> Any</button>
                        <button type="button" class="mood-btn" data-mood="comfort"><i class="fas fa-cookie"></i> Comfort</button>
                        <button type="button" class="mood-btn" data-mood="quick"><i class="fas fa-bolt"></i> Quick</button>
                        <button type="button" class="mood-btn" data-mood="energizing"><i class="fas fa-battery-full"></i> Energizing</button>
                        <button type="button" class="mood-btn" data-mood="light"><i class="fas fa-leaf"></i> Light</button>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="checkbox-group">
                        <input type="checkbox" id="mpDietR" name="mpDietR">
                        <label for="mpDietR"><i class="fas fa-allergies"></i> Any Dietary Restrictions?</label>
                    </div>
                </div>
                
                <div id="dietaryDetails" style="display: none;">
                    <div class="form-group">
                        <label for="mpDietDetails"><i class="fas fa-info-circle"></i> Specify Restrictions</label>
                        <input type="text" id="mpDietDetails" name="mpDietDetails" placeholder="e.g., gluten-free, vegetarian, nut-free">
                    </div>
                </div>
                
                <button type="submit" id="btn-submit-create" class="btn-submit">
                    <i class="fas fa-magic"></i> Generate Meal Plan
                    <span id="loadingSpinner" class="loading" style="display: none;"></span>
                </button>
            </form>
            
            <!-- Action Buttons -->
            <div class="action-buttons-container" id="actionButtons" style="display: none;">
                <button id="btn-new-plan" class="btn-primary">
                    <i class="fas fa-calendar-plus"></i> Generate New Plan
                </button>
                <button id="btn-add-to-planner" class="btn-primary">
                    <i class="fas fa-calendar-check"></i> Save to Planner
                </button>
            </div>

            <!-- Daily Meal Card -->
            <div class="daily-meal-card" id="dailyMealCard" style="display: none;">
                <div class="daily-meal-header">
                    <h2 class="daily-meal-name" id="dailyMealName">Your Daily Meal</h2>
                    <div class="daily-meal-type">
                        <i class="fas fa-utensils"></i> 
                        <span id="dailyMealType">Dinner</span>
                    </div>
                </div>
                
                <div class="daily-meal-details">
                    <div class="daily-meal-meta">
                        <div class="daily-meta-item">
                            <div class="daily-meta-value" id="dailyPrepTime">0 min</div>
                            <div class="daily-meta-label">Prep Time</div>
                        </div>
                        <div class="daily-meta-item">
                            <div class="daily-meta-value" id="dailyCalories">0</div>
                            <div class="daily-meta-label">Calories</div>
                        </div>
                        <div class="daily-meta-item">
                            <div class="daily-meta-value" id="dailyCost">$0.00</div>
                            <div class="daily-meta-label">Cost</div>
                        </div>
                    </div>
                    
                    <p class="daily-meal-description" id="dailyMealDescription">
                        Your generated meal description will appear here.
                    </p>
                    
                    <div class="daily-meal-actions">
                        <button class="daily-action-btn" id="btn-new-daily">
                            <i class="fas fa-redo"></i> Generate Another
                        </button>
                        <button class="daily-action-btn" id="btn-add-to-calendar">
                            <i class="fas fa-calendar-plus"></i> Add to Calendar
                        </button>
                    </div>
                </div>
            </div>

            <!-- Weekly Plan -->
            <div class="weekly-plan" id="weeklyPlan" style="display: none;">
                <!-- Day cards will be populated by JavaScript -->
            </div>

            <!-- Weekly Summary -->
            <div class="weekly-summary" id="weeklySummary" style="display: none;">
                <div class="summary-card">
                    <i class="fas fa-dollar-sign"></i>
                    <div class="summary-value" id="costValue">$0.00</div>
                    <div class="summary-label">Estimated Cost</div>
                </div>
                <div class="summary-card">
                    <i class="fas fa-fire"></i>
                    <div class="summary-value" id="caloriesValue">0</div>
                    <div class="summary-label">Total Calories</div>
                </div>
                <div class="summary-card">
                    <i class="fas fa-clock"></i>
                    <div class="summary-value" id="prepTimeValue">0h 0m</div>
                    <div class="summary-label">Prep Time</div>
                </div>
                <div class="summary-card">
                    <i class="fas fa-carrot"></i>
                    <div class="summary-value" id="ingredientsValue">0</div>
                    <div class="summary-label">Unique Ingredients</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Meal Details Modal -->
    <div class="meal-modal" id="mealModal">
      <div class="modal-content">
        <button class="close-modal">&times;</button>
        <h2 class="modal-day-name" id="modalDayName">Monday</h2>
        <div class="modal-date" id="modalDate">Loading date...</div>
        <div class="modal-meals-container" id="modalMealsContainer"></div>
      </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Savory Meal Planner</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* Your existing CSS styles here */
        /* ... */
    </style>
</head>
<body>
    <!-- Your existing HTML structure here -->
    <!-- ... -->

<script>
// Supabase Configuration
const SUPABASE_URL = 'https://cnmapvrdamsugtdnuesh.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNubWFwdnJkYW1zdWd0ZG51ZXNoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTAyODYzMzYsImV4cCI6MjA2NTg2MjMzNn0.sLeHEQYRJSrCTDN7yi6zWSJ1Qb_6xtEZJzgJHeZfpo8';

// Initialize Supabase client
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// Global variables
let currentPlan = null;
let currentUser = null;
let isSignUp = false;
let userInventory = [];
let cachedWeeklyPlan = null;

// Initialize the application
document.addEventListener('DOMContentLoaded', async function() {
    // Check user session
    const { data: { user }, error } = await supabase.auth.getUser();
    if (user) {
        currentUser = user;
        document.getElementById('streakCount').textContent = '5';
        document.getElementById('authText').textContent = 'Logout';
        document.getElementById('mainContent').style.display = 'block';
        document.getElementById('authForm').style.display = 'none';
        await loadUserInventory();
    } else {
        document.getElementById('authForm').style.display = 'block';
        document.getElementById('mainContent').style.display = 'none';
        document.getElementById('authText').textContent = 'Login';
    }
    
    setupEventListeners();
    initDayCards();
    setupModal();
});

// Set up all event listeners
function setupEventListeners() {
    // Authentication toggle
    document.getElementById('authToggleLink').addEventListener('click', function(e) {
        e.preventDefault();
        isSignUp = !isSignUp;
        
        if (isSignUp) {
            this.textContent = 'Already have an account? Login';
            document.getElementById('authSubmitBtn').innerHTML = '<i class="fas fa-user-plus"></i> Sign Up';
            document.getElementById('authNameGroup').style.display = 'block';
        } else {
            this.textContent = 'Don\'t have an account? Sign up';
            document.getElementById('authSubmitBtn').innerHTML = '<i class="fas fa-sign-in-alt"></i> Login';
            document.getElementById('authNameGroup').style.display = 'none';
        }
    });
    
    // Authentication button
    document.getElementById('authSubmitBtn').addEventListener('click', handleAuth);
    
    // Logout button
    document.getElementById('userAuthBtn').addEventListener('click', handleLogout);
    
    // Hamburger menu toggle
    const hamburgerMenu = document.getElementById('hamburgerMenu');
    if (hamburgerMenu) {
        hamburgerMenu.addEventListener('click', function() {
            this.classList.toggle('active');
            const navLinks = document.querySelector('.nav-links');
            if (navLinks) {
                navLinks.classList.toggle('active');
                document.body.style.overflow = this.classList.contains('active') ? 'hidden' : 'auto';
            }
        });
    }
    
    // Plan type toggle
    document.querySelectorAll('.plan-type-btn').forEach(btn => {
        btn.addEventListener('click', handlePlanTypeToggle);
    });
    
    // Dietary restrictions toggle
    const mpDietR = document.getElementById('mpDietR');
    if (mpDietR) {
        mpDietR.addEventListener('change', function() {
            const dietaryDetails = document.getElementById('dietaryDetails');
            if (dietaryDetails) {
                dietaryDetails.style.display = this.checked ? 'block' : 'none';
            }
        });
    }
    
    // Mood selector buttons
    document.querySelectorAll('.mood-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.mood-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
        });
    });
    
    // Inventory toggle
    const useInventory = document.getElementById('useInventory');
    if (useInventory) {
        useInventory.addEventListener('change', function() {
            const inventoryItems = document.getElementById('inventoryItems');
            if (inventoryItems) {
                inventoryItems.style.display = this.checked ? 'block' : 'none';
            }
        });
    }
    
    // Form submission
    const mealPlannerForm = document.getElementById('mealPlannerForm');
    if (mealPlannerForm) {
        mealPlannerForm.addEventListener('submit', handleFormSubmit);
    }
    
    // Action buttons
    const btnNewPlan = document.getElementById('btn-new-plan');
    if (btnNewPlan) {
        btnNewPlan.addEventListener('click', function() {
            const mealPlannerForm = document.getElementById('mealPlannerForm');
            if (mealPlannerForm) {
                mealPlannerForm.dispatchEvent(new Event('submit'));
            }
        });
    }
    
    const btnNewDaily = document.getElementById('btn-new-daily');
    if (btnNewDaily) {
        btnNewDaily.addEventListener('click', function() {
            const mealPlannerForm = document.getElementById('mealPlannerForm');
            if (mealPlannerForm) {
                mealPlannerForm.dispatchEvent(new Event('submit'));
            }
        });
    }
    
    const btnAddToPlanner = document.getElementById('btn-add-to-planner');
    if (btnAddToPlanner) {
        btnAddToPlanner.addEventListener('click', saveMealPlanToDatabase);
    }
    
    const btnAddToCalendar = document.getElementById('btn-add-to-calendar');
    if (btnAddToCalendar) {
        btnAddToCalendar.addEventListener('click', function() {
            showToast('Daily meal added to your calendar!', 'success');
        });
    }
}

async function handleAuth() {
    const email = document.getElementById('authEmail').value;
    const password = document.getElementById('authPassword').value;
    
    if (!email || !password) {
        showToast('Please enter email and password', 'error');
        return;
    }
    
    try {
        if (isSignUp) {
            const name = document.getElementById('authName').value || '';
            const { data, error } = await supabase.auth.signUp({
                email: email,
                password: password,
                options: {
                    data: {
                        full_name: name,
                        streak: 0
                    }
                }
            });
            
            if (error) throw error;
            showToast('Sign up successful! Please check your email for confirmation.', 'success');
        } else {
            const { data, error } = await supabase.auth.signInWithPassword({
                email: email,
                password: password
            });
            
            if (error) throw error;
            currentUser = data.user;
            document.getElementById('streakCount').textContent = '5';
            document.getElementById('authText').textContent = 'Logout';
            document.getElementById('mainContent').style.display = 'block';
            document.getElementById('authForm').style.display = 'none';
            await loadUserInventory();
            showToast('Login successful!', 'success');
        }
    } catch (error) {
        console.error('Authentication error:', error);
        showToast(`Authentication failed: ${error.message}`, 'error');
    }
}

async function handleLogout(e) {
    e.preventDefault();
    
    if (currentUser) {
        await supabase.auth.signOut();
        currentUser = null;
        document.getElementById('authText').textContent = 'Login';
        document.getElementById('mainContent').style.display = 'none';
        document.getElementById('authForm').style.display = 'block';
        showToast('Logged out successfully', 'success');
    } else {
        document.getElementById('mainContent').style.display = 'none';
        document.getElementById('authForm').style.display = 'block';
    }
}

function handlePlanTypeToggle() {
    document.querySelectorAll('.plan-type-btn').forEach(b => b.classList.remove('active'));
    this.classList.add('active');
    
    const planType = this.dataset.planType;
    
    if (planType === 'weekly') {
        document.getElementById('weeklyPlan').style.display = 'grid';
        document.getElementById('weeklySummary').style.display = 'grid';
        document.getElementById('dailyMealCard').style.display = 'none';
        document.getElementById('moodSelectorContainer').style.display = 'none';
        
        if (cachedWeeklyPlan) {
            updateDayCards(cachedWeeklyPlan.plan);
            updateWeeklySummary(cachedWeeklyPlan.summary);
        }
    } else {
        document.getElementById('weeklyPlan').style.display = 'none';
        document.getElementById('weeklySummary').style.display = 'none';
        document.getElementById('dailyMealCard').style.display = 'block';
        document.getElementById('moodSelectorContainer').style.display = 'block';
    }
    
    const submitBtn = document.getElementById('btn-submit-create');
    if (submitBtn) {
        submitBtn.innerHTML = planType === 'weekly' 
            ? '<i class="fas fa-magic"></i> Generate Meal Plan' 
            : '<i class="fas fa-magic"></i> Generate Daily Meal';
    }
}

async function handleFormSubmit(e) {
    e.preventDefault();
    
    if (!currentUser) {
        showToast('Please log in to generate meal plans', 'error');
        return;
    }
    
    const submitBtn = document.getElementById('btn-submit-create');
    const spinner = document.getElementById('loadingSpinner');
    
    if (submitBtn) submitBtn.disabled = true;
    if (spinner) spinner.style.display = 'inline-block';
    
    const loadingOverlay = document.getElementById('loadingOverlay');
    if (loadingOverlay) loadingOverlay.classList.add('active');
    
    const planType = document.querySelector('.plan-type-btn.active')?.dataset.planType || 'weekly';
    const useInventory = document.getElementById('useInventory')?.checked || false;
    
    const formData = {
        planType: planType,
        budget: document.getElementById('mpBudget')?.value || '150',
        specificFoods: document.getElementById('mpSpecific')?.value || '',
        dietaryRestrictions: document.getElementById('mpDietR')?.checked ? 
            document.getElementById('mpDietDetails')?.value : '',
        useInventory: useInventory,
        inventoryItems: useInventory ? userInventory : [],
        mood: planType === 'daily' ? 
            document.querySelector('.mood-btn.active')?.dataset.mood : ''
    };
    
    try {
        const response = await generateMealPlan(formData);
        
        currentPlan = {
            type: planType,
            data: response
        };
        
        if (planType === 'weekly') {
            cachedWeeklyPlan = response;
            updateDayCards(response.plan);
            updateWeeklySummary(response.summary);
            document.getElementById('weeklyPlan').style.display = 'grid';
            document.getElementById('weeklySummary').style.display = 'grid';
            document.getElementById('dailyMealCard').style.display = 'none';
            showToast('Weekly meal plan generated successfully!', 'success');
        } else {
            displayDailyMeal(response);
            document.getElementById('weeklyPlan').style.display = 'none';
            document.getElementById('weeklySummary').style.display = 'none';
            showToast('Daily meal generated successfully!', 'success');
        }
        
        document.getElementById('actionButtons').style.display = 'flex';
    } catch (error) {
        console.error('Error generating meal plan:', error);
        showToast(`Error: ${error.message}`, 'error');
    } finally {
        if (submitBtn) submitBtn.disabled = false;
        if (spinner) spinner.style.display = 'none';
        if (loadingOverlay) loadingOverlay.classList.remove('active');
    }
}

async function saveMealPlanToDatabase() {
    if (!currentUser || !currentPlan) {
        showToast('No plan to save or user not logged in', 'error');
        return;
    }

    try {
        const loadingOverlay = document.getElementById('loadingOverlay');
        if (loadingOverlay) loadingOverlay.classList.add('active');

        const planToSave = {
            user_id: currentUser.id,
            plan_type: currentPlan.type,
            plan_data: currentPlan.data,
            created_at: new Date().toISOString(),
            updated_at: new Date().toISOString(),
            start_date: new Date().toISOString(),
            end_date: currentPlan.type === 'weekly' ? 
                new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString() :
                new Date().toISOString(),
            status: 'active',
            version: 1
        };

        // Try to save to meal_plans table
        const { data, error } = await supabase
            .from('meal_plans')
            .insert([planToSave])
            .select();

        if (error) {
            if (error.code === '42P01') { // Table doesn't exist
                showToast('Database tables not set up. Please create the meal_plans table in Supabase.', 'error');
                console.error('Database tables not set up:', error);
                return;
            }
            throw error;
        }

        if (!data || data.length === 0) {
            throw new Error('No data returned from insert operation');
        }

        const insertedPlanId = data[0].id;

        // Save individual meals
        if (currentPlan.type === 'weekly') {
            const mealsToInsert = [];
            const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
            
            days.forEach(day => {
                if (currentPlan.data.plan && currentPlan.data.plan[day]) {
                    currentPlan.data.plan[day].forEach(meal => {
                        mealsToInsert.push({
                            plan_id: insertedPlanId,
                            user_id: currentUser.id,
                            day_of_week: day,
                            meal_type: meal.type,
                            meal_name: meal.name,
                            description: meal.description,
                            prep_time: meal.prepTime,
                            calories: meal.calories,
                            cost: meal.cost || '0.00',
                            ingredients: JSON.stringify(meal.ingredients || []),
                            instructions: JSON.stringify(meal.steps || []),
                            created_at: new Date().toISOString()
                        });
                    });
                }
            });

            if (mealsToInsert.length > 0) {
                const { error: mealsError } = await supabase
                    .from('meals')
                    .insert(mealsToInsert);
                
                if (mealsError) throw mealsError;
            }
        } else {
            const { error: mealError } = await supabase
                .from('meals')
                .insert([{
                    plan_id: insertedPlanId,
                    user_id: currentUser.id,
                    day_of_week: new Date().toLocaleDateString('en-US', { weekday: 'long' }),
                    meal_type: currentPlan.data.type,
                    meal_name: currentPlan.data.name,
                    description: currentPlan.data.description,
                    prep_time: currentPlan.data.prepTime,
                    calories: currentPlan.data.calories,
                    cost: currentPlan.data.cost || '0.00',
                    ingredients: JSON.stringify(currentPlan.data.ingredients || []),
                    instructions: JSON.stringify(currentPlan.data.steps || []),
                    created_at: new Date().toISOString()
                }]);
            
            if (mealError) throw mealError;
        }

        showToast('Meal plan saved successfully!', 'success');
    } catch (error) {
        console.error('Error saving meal plan:', error);
        showToast('Failed to save meal plan: ' + error.message, 'error');
    } finally {
        const loadingOverlay = document.getElementById('loadingOverlay');
        if (loadingOverlay) loadingOverlay.classList.remove('active');
    }
}

// Load user inventory from Supabase
async function loadUserInventory() {
    if (!currentUser) return;
    
    try {
        const { data, error } = await supabase
            .from('inventory_items')
            .select('*')
            .eq('user_id', currentUser.id);
        
        if (error) throw error;
        
        userInventory = data || [];
        displayInventoryItems(userInventory);
    } catch (error) {
        console.error('Error loading inventory:', error);
        showToast('Failed to load inventory', 'error');
    }
}

// Display inventory items
function displayInventoryItems(items) {
    const container = document.getElementById('inventoryItems');
    if (!container) return;
    
    container.innerHTML = '';
    
    if (items.length === 0) {
        container.innerHTML = '<div class="inventory-item">No items in inventory</div>';
        return;
    }
    
    items.forEach(item => {
        const itemEl = document.createElement('div');
        itemEl.className = 'inventory-item';
        
        // Calculate expiry status
        let expiryClass = '';
        let expiryText = 'No expiry';
        if (item.expiry_date) {
            const today = new Date();
            const expiryDate = new Date(item.expiry_date);
            const diffDays = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));
            
            if (diffDays < 0) {
                expiryClass = 'expired';
                expiryText = 'Expired';
            } else if (diffDays <= 3) {
                expiryClass = 'expiring-soon';
                expiryText = `Expires in ${diffDays} days`;
            } else {
                expiryClass = 'fresh';
                expiryText = `Expires in ${diffDays} days`;
            }
        }
        
        itemEl.innerHTML = `
            <div>
                <span>${item.name} (${item.quantity} ${item.unit})</span>
                <span class="item-expiry ${expiryClass}">${expiryText}</span>
            </div>
        `;
        container.appendChild(itemEl);
    });
}

// Generate meal plan using OpenAI API via Supabase Edge Function
async function generateMealPlan(formData) {
    try {
        // Show loading overlay
        const loadingOverlay = document.getElementById('loadingOverlay');
        if (loadingOverlay) loadingOverlay.classList.add('active');

        // Prepare the prompt for OpenAI
        let prompt = `Generate a ${formData.planType} meal plan with the following requirements:\n`;
        prompt += `- Budget: $${formData.budget}\n`;
        
        if (formData.specificFoods) {
            prompt += `- Must include these foods: ${formData.specificFoods}\n`;
        }
        
        if (formData.dietaryRestrictions) {
            prompt += `- Dietary restrictions: ${formData.dietaryRestrictions}\n`;
        }
        
        if (formData.useInventory && formData.inventoryItems.length > 0) {
            prompt += `- Available ingredients: ${formData.inventoryItems.map(item => item.name).join(', ')}\n`;
        }
        
        if (formData.planType === 'daily' && formData.mood) {
            prompt += `- Meal mood: ${formData.mood}\n`;
        }
        
        prompt += `\nPlease provide the response in JSON format with the following structure:\n`;
        
        if (formData.planType === 'weekly') {
            prompt += `{
                "plan": {
                    "Monday": [
                        {
                            "name": "Meal name",
                            "type": "Breakfast/Lunch/Dinner",
                            "prepTime": "X min",
                            "calories": X,
                            "description": "Meal description",
                            "ingredients": ["ingredient1", "ingredient2"],
                            "steps": ["step1", "step2"]
                        }
                    ],
                    // ... other days
                },
                "summary": {
                    "totalCost": X.XX,
                    "totalCalories": XXXX,
                    "totalPrepTime": "Xh XXm",
                    "uniqueIngredients": XX
                }
            }`;
        } else {
            prompt += `{
                "name": "Meal name",
                "type": "Breakfast/Lunch/Dinner",
                "prepTime": "X min",
                "calories": X,
                "cost": "$X.XX",
                "description": "Meal description",
                "ingredients": ["ingredient1", "ingredient2"],
                "steps": ["step1", "step2"]
            }`;
        }

        // Call Supabase Edge Function to interact with OpenAI
        const { data, error } = await supabase.functions.invoke('generate-meal-plan', {
            body: {
                prompt: prompt,
                planType: formData.planType
            }
        });

        if (error) throw error;
        
        // Parse the response (assuming the Edge Function returns properly formatted JSON)
        const result = typeof data === 'string' ? JSON.parse(data) : data;
        
        // For demo purposes, if the API call fails, use mock data
        if (!result || (formData.planType === 'weekly' && !result.plan) || 
            (formData.planType === 'daily' && !result.name)) {
            console.warn('Using mock data as fallback');
            return generateMockMealPlan(formData);
        }

        return result;
    } catch (error) {
        console.error('Error in generateMealPlan:', error);
        
        // Fallback to mock data if API fails
        showToast('Using mock data as API failed', 'warning');
        return generateMockMealPlan(formData);
    } finally {
        const loadingOverlay = document.getElementById('loadingOverlay');
        if (loadingOverlay) loadingOverlay.classList.remove('active');
    }
}

// Generate mock meal plan based on form data (fallback)
function generateMockMealPlan(formData) {
    const { planType, budget, specificFoods, dietaryRestrictions, useInventory, inventoryItems, mood } = formData;
    
    // If using inventory, incorporate inventory items into the meal plan
    const inventoryIngredients = useInventory ? 
        inventoryItems.map(item => item.name.toLowerCase()) : [];
    
    if (planType === 'daily') {
        // Generate daily meal based on inventory if enabled
        const meals = [];
        
        // Meal 1 - Uses inventory if possible
        meals.push({
            name: inventoryIngredients.includes('chicken') ? 
                "Mediterranean Chicken Bowl" : "Vegetable Stir Fry with Tofu",
            type: "Dinner",
            prepTime: "30 min",
            calories: 520,
            cost: "$5.25",
            description: inventoryIngredients.includes('chicken') ? 
                "A delicious bowl featuring grilled chicken, quinoa, fresh vegetables, olives, and feta cheese with a tangy lemon-herb dressing." : 
                "A quick and nutritious stir fry with crispy tofu and seasonal vegetables in a savory sauce.",
            ingredients: inventoryIngredients.includes('chicken') ? [
                "Chicken breast (200g)",
                "Quinoa (1 cup)",
                "Cherry tomatoes (100g)",
                "Cucumber (1/2)",
                "Feta cheese (50g)",
                "Kalamata olives (10)",
                "Lemon (1)",
                "Olive oil (1 tbsp)",
                "Fresh herbs"
            ] : [
                "Firm tofu (200g)",
                "Broccoli (1 cup)",
                "Bell peppers (2)",
                "Carrots (2)",
                "Soy sauce (2 tbsp)",
                "Ginger (1 tsp)",
                "Garlic (2 cloves)",
                "Sesame oil (1 tsp)",
                "Rice (1 cup)"
            ],
            steps: inventoryIngredients.includes('chicken') ? [
                "Cook quinoa according to package instructions and let cool",
                "Season chicken breast with salt, pepper, and herbs, then grill until cooked through",
                "Chop vegetables and olives",
                "Prepare dressing by whisking lemon juice, olive oil, and herbs",
                "Assemble bowls with quinoa, sliced chicken, vegetables, and olives",
                "Drizzle with dressing and top with crumbled feta cheese"
            ] : [
                "Press tofu to remove excess water, then cube and pan-fry until golden",
                "Chop vegetables into bite-sized pieces",
                "Stir-fry vegetables in sesame oil with ginger and garlic",
                "Add tofu and soy sauce, cook for 5 more minutes",
                "Serve over cooked rice"
            ]
        });
        
        // Select meal based on mood if specified
        let selectedMeal = meals[0];
        if (mood === 'comfort') {
            selectedMeal = {
                name: "Mac and Cheese",
                type: "Dinner",
                prepTime: "25 min",
                calories: 650,
                cost: "$4.50",
                description: "Classic comfort food with creamy cheese sauce and elbow macaroni.",
                ingredients: [
                    "Elbow macaroni (2 cups)",
                    "Cheddar cheese (200g)",
                    "Milk (1 cup)",
                    "Butter (2 tbsp)",
                    "Flour (2 tbsp)"
                ],
                steps: [
                    "Cook macaroni according to package directions",
                    "Melt butter in saucepan, whisk in flour to make a roux",
                    "Gradually add milk, stirring constantly until thickened",
                    "Add shredded cheese and stir until melted",
                    "Combine cheese sauce with cooked macaroni"
                ]
            };
        } else if (mood === 'quick') {
            selectedMeal = {
                name: "Avocado Toast with Egg",
                type: "Breakfast",
                prepTime: "10 min",
                calories: 350,
                cost: "$3.00",
                description: "Simple and nutritious breakfast with whole grain toast, mashed avocado, and a fried egg.",
                ingredients: [
                    "Whole grain bread (2 slices)",
                    "Avocado (1)",
                    "Eggs (2)",
                    "Salt and pepper to taste",
                    "Red pepper flakes (optional)"
                ],
                steps: [
                    "Toast bread to desired doneness",
                    "Mash avocado and spread on toast",
                    "Fry eggs to preferred doneness",
                    "Place eggs on avocado toast",
                    "Season with salt, pepper, and red pepper flakes"
                ]
            };
        }
        
        return selectedMeal;
    } else {
        // Generate weekly plan that considers inventory if enabled
        const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
        const mealTypes = ['Breakfast', 'Lunch', 'Dinner'];
        
        const plan = {};
        days.forEach(day => {
            plan[day] = mealTypes.map(type => {
                // Create meals that use inventory items if available
                let name, description;
                
                if (inventoryIngredients.includes('chicken') && type === 'Dinner') {
                    name = "Chicken Stir Fry";
                    description = "A quick dinner using your chicken with fresh vegetables";
                } else if (inventoryIngredients.includes('eggs') && type === 'Breakfast') {
                    name = "Vegetable Omelette";
                    description = "Fluffy omelette with vegetables using your eggs";
                } else if (inventoryIngredients.includes('pasta') && type === 'Dinner') {
                    name = "Pasta Primavera";
                    description = "Pasta dish with seasonal vegetables";
                } else {
                    // Fallback to generic meals
                    const genericMeals = [
                        {name: "Oatmeal with Berries", desc: "Healthy breakfast with oats and fresh berries"},
                        {name: "Quinoa Salad", desc: "Nutritious lunch with quinoa and vegetables"},
                        {name: "Grilled Salmon", desc: "Delicious dinner with fresh salmon"},
                        {name: "Vegetable Wrap", desc: "Light lunch wrap with fresh veggies"},
                        {name: "Yogurt Parfait", desc: "Breakfast with yogurt and granola"}
                    ];
                    const randomMeal = genericMeals[Math.floor(Math.random() * genericMeals.length)];
                    name = randomMeal.name;
                    description = randomMeal.desc;
                }
                
                return {
                    name: name,
                    type: type,
                    prepTime: `${10 + Math.floor(Math.random() * 30)} min`,
                    calories: 300 + Math.floor(Math.random() * 400),
                    description: description,
                    ingredients: ["Ingredient 1", "Ingredient 2", "Ingredient 3"],
                    steps: ["Step 1", "Step 2", "Step 3"]
                };
            });
        });
        
        const summary = {
            totalCost: (budget * 0.8).toFixed(2),
            totalCalories: Math.floor(2000 * 7 * 0.9),
            totalPrepTime: "6h 45m",
            uniqueIngredients: useInventory ? 
                Math.min(35, inventoryItems.length + 15) : 35
        };
        
        return { plan, summary };
    }
}

// Initialize day cards
function initDayCards() {
    const weeklyPlanEl = document.getElementById('weeklyPlan');
    if (!weeklyPlanEl) return;

    const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
    
    weeklyPlanEl.innerHTML = days.map(day => `
        <div class="day-card ${day === new Date().toLocaleDateString('en-US', { weekday: 'long' }) ? 'today' : ''}">
            <div class="day-header">
                <h3 class="day-name">${day}</h3>
                <div class="date">${new Date().toLocaleDateString()}</div>
            </div>
            <div class="meal-container" id="${day.toLowerCase()}-meals">
                <div class="empty-state">
                    <i class="fas fa-utensils"></i>
                    <p>No meals planned yet</p>
                </div>
            </div>
        </div>
    `).join('');
}

// Update day cards with meal plan data
function updateDayCards(planData) {
    const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
    
    days.forEach(day => {
        const dayMealsContainer = document.getElementById(`${day.toLowerCase()}-meals`);
        if (!dayMealsContainer) return;
        
        const meals = planData[day];
        if (!meals || meals.length === 0) {
            dayMealsContainer.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-utensils"></i>
                    <p>No meals planned for ${day}</p>
                </div>
            `;
            return;
        }
        
        dayMealsContainer.innerHTML = meals.map(meal => `
            <div class="meal-item">
                <h4>${meal.name}</h4>
                <p><small>${meal.type} • ${meal.prepTime} • ${meal.calories} cal</small></p>
                <p>${meal.description}</p>
            </div>
        `).join('');
    });
}

// Update weekly summary
function updateWeeklySummary(summaryData) {
    if (!summaryData) return;
    
    const costValue = document.getElementById('costValue');
    const caloriesValue = document.getElementById('caloriesValue');
    const prepTimeValue = document.getElementById('prepTimeValue');
    const ingredientsValue = document.getElementById('ingredientsValue');
    
    if (costValue) costValue.textContent = `$${summaryData.totalCost}`;
    if (caloriesValue) caloriesValue.textContent = summaryData.totalCalories;
    if (prepTimeValue) prepTimeValue.textContent = summaryData.totalPrepTime;
    if (ingredientsValue) ingredientsValue.textContent = summaryData.uniqueIngredients;
}

// Display daily meal
function displayDailyMeal(mealData) {
    const dailyMealName = document.getElementById('dailyMealName');
    const dailyMealType = document.getElementById('dailyMealType');
    const dailyPrepTime = document.getElementById('dailyPrepTime');
    const dailyCalories = document.getElementById('dailyCalories');
    const dailyCost = document.getElementById('dailyCost');
    const dailyMealDescription = document.getElementById('dailyMealDescription');
    
    if (dailyMealName) dailyMealName.textContent = mealData.name;
    if (dailyMealType) dailyMealType.textContent = mealData.type;
    if (dailyPrepTime) dailyPrepTime.textContent = mealData.prepTime;
    if (dailyCalories) dailyCalories.textContent = mealData.calories;
    if (dailyCost) dailyCost.textContent = mealData.cost;
    if (dailyMealDescription) dailyMealDescription.textContent = mealData.description;
}

// Setup modal
function setupModal() {
    const modal = document.getElementById('mealModal');
    if (!modal) return;
    
    const closeModal = modal.querySelector('.close-modal');
    if (closeModal) {
        closeModal.addEventListener('click', function() {
            modal.classList.remove('active');
        });
    }
    
    // Close modal when clicking outside
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            modal.classList.remove('active');
        }
    });
}

// Show toast notification
function showToast(message, type = 'success') {
    const toast = document.getElementById('toast');
    if (!toast) return;
    
    toast.textContent = message;
    toast.className = `toast ${type}`;
    toast.classList.add('show');
    
    setTimeout(() => {
        toast.classList.remove('show');
    }, 3000);
}
</script>
</body>
</html>
