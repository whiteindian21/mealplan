<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Add Item – Smart Meal App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Dancing+Script:wght@700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    :root {
      --primary: #e74c3c;
      --primary-light: #ff9a9e;
      --secondary: #3498db;
      --dark: #2c3e50;
      --light: #ecf0f1;
      --gray: #95a5a6;
      --success: #2ecc71;
      --warning: #f39c12;
      --danger: #e74c3c;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      color: var(--dark);
      min-height: 100vh;
      padding: 20px;
      display: flex;
      flex-direction: column;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
      width: 100%;
      background: white;
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      padding: 30px;
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
    }

    .logo {
      font-family: 'Dancing Script', cursive;
      font-size: 2.5rem;
      color: var(--primary);
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .logo i {
      margin-right: 10px;
    }

    .page-title {
      font-size: 1.5rem;
      color: var(--dark);
      margin-bottom: 5px;
    }

    .page-subtitle {
      color: var(--gray);
      font-size: 1rem;
    }

    .camera {
      margin-bottom: 25px;
      position: relative;
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .camera video {
      width: 100%;
      display: block;
      background: var(--dark);
    }

    .camera-controls {
      padding: 15px;
      background: white;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .capture-btn {
      background: linear-gradient(45deg, var(--primary), var(--primary-light));
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 50px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 5px 15px rgba(231, 76, 60, 0.3);
      width: 100%;
      max-width: 200px;
    }

    .capture-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(231, 76, 60, 0.4);
    }

    .capture-btn:active {
      transform: translateY(0);
    }

    .capture-btn i {
      margin-right: 8px;
    }

    .camera-status {
      margin-top: 10px;
      font-size: 0.9rem;
      text-align: center;
      min-height: 20px;
    }

    .camera-status.error {
      color: var(--danger);
    }

    .camera-status.success {
      color: var(--success);
    }

    .divider {
      display: flex;
      align-items: center;
      margin: 20px 0;
      color: var(--gray);
    }

    .divider::before,
    .divider::after {
      content: "";
      flex: 1;
      border-bottom: 1px solid #eee;
    }

    .divider span {
      padding: 0 15px;
      font-size: 0.9rem;
    }

    .manual-input {
      margin-top: 10px;
    }

    .sub-heading {
      font-size: 1.2rem;
      color: var(--dark);
      margin-bottom: 15px;
      text-align: center;
      position: relative;
    }

    .sub-heading::after {
      content: "";
      position: absolute;
      bottom: -8px;
      left: 50%;
      transform: translateX(-50%);
      width: 50px;
      height: 3px;
      background: linear-gradient(to right, var(--primary), var(--primary-light));
      border-radius: 3px;
    }

    #manualInputForm {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    #manualInputForm input {
      padding: 15px 20px;
      border: 2px solid #eee;
      border-radius: 10px;
      font-size: 1rem;
      transition: all 0.3s ease;
      outline: none;
      font-family: 'Poppins', sans-serif;
    }

    #manualInputForm input:focus {
      border-color: var(--primary-light);
      box-shadow: 0 5px 15px rgba(255, 154, 158, 0.2);
    }

    #manualInputForm input::placeholder {
      color: #ccc;
    }

    .btn-submit {
      background: linear-gradient(45deg, var(--primary), var(--primary-light));
      color: white;
      padding: 15px;
      border: none;
      border-radius: 10px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 5px 15px rgba(231, 76, 60, 0.3);
    }

    .btn-submit:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(231, 76, 60, 0.4);
    }

    .btn-submit:active {
      transform: translateY(0);
    }

    .btn-submit i {
      margin-right: 8px;
    }

    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top: 3px solid white;
      animation: spin 1s linear infinite;
      margin-left: 10px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--dark);
      color: white;
      padding: 12px 25px;
      border-radius: 50px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
      z-index: 1000;
      display: flex;
      align-items: center;
    }

    .toast.show {
      opacity: 1;
      visibility: visible;
    }

    .toast i {
      margin-right: 10px;
    }

    .toast.success {
      background: var(--success);
    }

    .toast.error {
      background: var(--danger);
    }

    @media (max-width: 768px) {
      .container {
        padding: 20px;
      }

      .logo {
        font-size: 2rem;
      }

      .page-title {
        font-size: 1.3rem;
      }
    }

    @media (max-width: 480px) {
      body {
        padding: 10px;
      }

      .container {
        padding: 15px;
      }

      .capture-btn {
        padding: 10px 15px;
        font-size: 0.9rem;
      }

      #manualInputForm input {
        padding: 12px 15px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo">
        <i class="fas fa-utensils"></i>
        SmartMeal
      </div>
      <h1 class="page-title">Add Grocery Items</h1>
      <p class="page-subtitle">Scan or manually add items to your inventory</p>
    </div>

    <section class="camera" id="cameraView" aria-label="Camera View">
      <!-- Camera will be injected here -->
    </section>

    <div class="divider"><span>OR</span></div>

    <section class="manual-input" aria-label="Manual Item Entry">
      <h3 class="sub-heading">Add Item Manually</h3>
      <form id="manualInputForm" autocomplete="off">
        <label for="item-name" class="visually-hidden">Item Name</label>
        <input
          type="text"
          id="item-name"
          name="item-name"
          placeholder="e.g. Apples, Milk, Rice..."
          required
          aria-required="true"
        />
        <button type="submit" class="btn-submit">
          <i class="fas fa-plus"></i> Add Item
        </button>
      </form>
    </section>
  </div>

  <div class="toast" id="toast"></div>

  <!-- Load Supabase JS SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <script>
    // Initialize Supabase client
    const supabaseUrl = 'https://tciqpgkdvnjhqnunbals.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRjaXFwZ2tkdm5qaHFudW5iYWxzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTAyNzc2MjEsImV4cCI6MjA2NTg1MzYyMX0.ZCsOZFFX8YjcWPAF3YTzmNzcOYTPlG8ZlB1vI--BHDc';
    const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
    
    let currentUser = null;

    document.addEventListener('DOMContentLoaded', async () => {
        try {
            // Check initial auth state
            const { data: { session } } = await supabaseClient.auth.getSession();
            currentUser = session?.user ?? null;

            // Set up auth state listener
            supabaseClient.auth.onAuthStateChange((event, session) => {
                currentUser = session?.user ?? null;
                if (event === 'SIGNED_OUT') {
                    showToast("Please sign in to add items", "error");
                }
            });

            // Initialize app components
            setupCameraAndCapture();
            setupManualForm();

        } catch (error) {
            console.error('Initialization error:', error);
            showToast("Failed to initialize app. Please refresh.", "error");
        }
    });

    // Show toast notification
    function showToast(message, type = "") {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.className = 'toast';
        
        if (type === "error") {
            toast.classList.add('error');
        } else if (type === "success") {
            toast.classList.add('success');
        }
        
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 3000);
    }

    // Update inventory in Supabase with all fields
    async function updateUserInventory(itemData) {
        if (!currentUser) {
            throw new Error("Please sign in first");
        }

        const sanitizedItem = {
            name: itemData.name.toLowerCase().trim(),
            quantity: parseFloat(itemData.quantity) || 1,
            unit: itemData.unit || 'pieces',
            expiry_date: itemData.expiry || null,
            user_id: currentUser.id,
            category_id: null
        };

        if (!sanitizedItem.name) {
            throw new Error("Please enter a valid item name");
        }

        try {
            // Check for existing items
            const { data: existingItems, error: queryError } = await supabaseClient
                .from('inventory_items')
                .select('*')
                .eq('user_id', currentUser.id)
                .ilike('name', sanitizedItem.name);

            if (queryError) throw queryError;
            
            if (existingItems && existingItems.length > 0) {
                throw new Error("Item already exists in your inventory");
            }

            // Insert new item
            const { error: insertError } = await supabaseClient
                .from('inventory_items')
                .insert({
                    user_id: sanitizedItem.user_id,
                    name: sanitizedItem.name,
                    quantity: sanitizedItem.quantity,
                    unit: sanitizedItem.unit,
                    expiry_date: sanitizedItem.expiry_date,
                    category_id: sanitizedItem.category_id
                });

            if (insertError) throw insertError;
            
            return sanitizedItem.name;
        } catch (error) {
            console.error("Database error:", error);
            throw new Error(error.message || "Failed to update inventory. Please try again.");
        }
    }

    // Analyze image through Supabase Edge Function
    async function analyzeImageWithOpenAI(base64Image) {
        if (!currentUser) {
            throw new Error("Please sign in first");
        }

        try {
            // Call Supabase Edge Function
            const { data, error } = await supabaseClient.functions.invoke('analyze-image', {
                body: { image: base64Image }
            });

            if (error) throw error;
            if (!data?.itemName) throw new Error("Item not recognized. Please try again with a clearer image.");
            
            return data.itemName;
        } catch (error) {
            console.error("Image analysis error:", error);
            throw new Error("Failed to analyze image. " + (error.message || "Please try again."));
        }
    }

    // Camera setup and capture functionality
    async function setupCameraAndCapture() {
        const cameraView = document.getElementById("cameraView");
        if (!cameraView) return;

        cameraView.innerHTML = `
            <video autoplay playsinline></video>
            <div class="camera-controls">
                <button class="capture-btn" disabled>
                    <i class="fas fa-camera"></i> Loading Camera...
                </button>
                <div class="camera-status"></div>
            </div>
        `;

        const video = cameraView.querySelector("video");
        const captureBtn = cameraView.querySelector(".capture-btn");
        const statusDiv = cameraView.querySelector(".camera-status");

        let stream = null;

        try {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                throw new Error("Camera API not supported in this browser");
            }

            stream = await navigator.mediaDevices.getUserMedia({ 
                video: { 
                    facingMode: 'environment',
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                } 
            });
            
            video.srcObject = stream;
            
            await new Promise((resolve, reject) => {
                video.onloadedmetadata = () => {
                    video.play().then(resolve).catch(reject);
                };
                video.onerror = reject;
            });
            
            captureBtn.innerHTML = '<i class="fas fa-camera"></i> Capture Item';
            captureBtn.disabled = false;
            statusDiv.textContent = "Point your camera at a grocery item";

            captureBtn.addEventListener("click", handleCapture);

        } catch (error) {
            console.error("Camera error:", error);
            cameraView.innerHTML = `
                <div class="camera-controls">
                    <div class="camera-status error">
                        <i class="fas fa-exclamation-circle"></i> ${error.message || "Camera access failed"}
                    </div>
                    <button class="capture-btn" onclick="window.location.reload()">
                        <i class="fas fa-sync-alt"></i> Try Again
                    </button>
                </div>
            `;
            showToast(`Camera error: ${error.message}`, "error");
        }

        async function handleCapture() {
            if (!currentUser) {
                statusDiv.textContent = "Please sign in to add items";
                statusDiv.className = "camera-status error";
                showToast("Please sign in first", "error");
                return;
            }

            try {
                captureBtn.disabled = true;
                captureBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
                statusDiv.textContent = "Processing image...";
                statusDiv.className = "camera-status";
                
                const canvas = document.createElement("canvas");
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                const ctx = canvas.getContext("2d");
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                const imageData = canvas.toDataURL("image/jpeg", 0.8);
                
                statusDiv.textContent = "Identifying item...";
                const productName = await analyzeImageWithOpenAI(imageData);
                
                statusDiv.textContent = "Adding to your inventory...";
                await updateUserInventory({
                    name: productName,
                    quantity: 1,
                    unit: 'pieces',
                    expiry: null
                });
                
                statusDiv.textContent = `✅ Added: ${productName}`;
                statusDiv.className = "camera-status success";
                captureBtn.innerHTML = '<i class="fas fa-camera"></i> Capture Another';
                showToast(`Added: ${productName}`, "success");
                
            } catch (error) {
                console.error("Capture error:", error);
                statusDiv.textContent = error.message;
                statusDiv.className = "camera-status error";
                captureBtn.innerHTML = '<i class="fas fa-camera"></i> Try Again';
                showToast(error.message, "error");
            } finally {
                captureBtn.disabled = false;
            }
        }

        window.addEventListener('beforeunload', () => {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
        });
    }

    // Manual form submission
    function setupManualForm() {
        const manualForm = document.getElementById("manualInputForm");
        if (!manualForm) return;

        manualForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            
            const inputField = manualForm.querySelector("#item-name");
            const submitBtn = manualForm.querySelector("button[type='submit']");
            
            const itemData = {
                name: inputField.value.trim(),
                quantity: 1,
                unit: 'pieces',
                expiry: null
            };
            
            if (!itemData.name) {
                showToast("Please enter an item name", "error");
                return;
            }
            
            if (!currentUser) {
                showToast("Please sign in first", "error");
                return;
            }

            try {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Adding...';
                
                const addedItem = await updateUserInventory(itemData);
                showToast(`✅ Added: ${addedItem}`, "success");
                manualForm.reset();
                inputField.focus();
            } catch (error) {
                showToast(`❌ ${error.message}`, "error");
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-plus"></i> Add Item';
            }
        });
    }
  </script>
</body>
</html>
